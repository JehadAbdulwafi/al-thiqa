# لوحة التحكم - تحديثات ميزات الإدارة

## نظرة عامة (Overview)

تم تحديث لوحة التحكم بالكامل لعرض بيانات حقيقية من قاعدة البيانات، بالإضافة إلى ميزات إدارية جديدة تساعد المديرين.

## التغييرات المنفذة (Changes Implemented)

### 1. تحديث قاعدة البيانات (Database Schema)

**الجداول الجديدة:**
- `product_view_history`: تتبع جميع المشاهدات للمنتجات
- `monthly_stats`: تخزين إحصائيات شهرية للتحليل

**تحديثات الجداول الموجودة:**
- `products`: إضافة `view_count` و `last_viewed_at`

**ملف الترحيل:**
- `drizzle/0001_add_analytics.sql`: ترحيل قاعدة البيانات

### 2. وظائف الاستعلام (Query Functions)

**ملف جديد:** `lib/dashboard-queries.ts`

الوظائف المتاحة:
- `getDashboardStats()`: الحصول على إحصائيات لوحة التحكم
- `getStatsComparison()`: مقارنة الأرقام بالشهر السابق
- `getMonthlyTrends()`: بيانات الرسوم البيانية للأشهر الـ 6 الأخيرة
- `getTopProducts()`: المنتجات الأكثر مشاهدة
- `getRecentActivity()`: آخر الأنشاط من سجل النشاطات
- `getPendingTasks()`: حساب المهام المعلقة
- `getActivitySummary()`: ملخص شامل للنشاط
- `getUserActivityByRole()`: نشاط المستخدمين حسب الدور

### 3. إجراءات الخادم (Server Actions)

**ملف جديد:** `app/actions/analytics.ts`

الوظائف:
- `trackProductView(productId)`: تسجيل مشاهدات المنتجات مع منع التكرار في 24 ساعة
- `recordMonthlyStats()`: تسجيل الإحصائيات الشهرية

### 4. تحديث مكونات لوحة التحكم (Dashboard Components)

#### المكونات المحدثة بالبيانات الحقيقية:

**StatsCards** (`components/dashboard/stats-cards.tsx`)
- عرض إحصائيات حقيقية: المنتجات، المجموعات، المقالات، المستخدمين، المشاهدات
- عرض التغييرات مقارنة بالشهر السابق (أرقام إيجابية/سلبية باللون الأخضر/الأحمر)

**SalesChart** (`components/dashboard/sales-chart.tsx`)
- رسم بياني للمشاهدات والمنتجات والمقالات على مدار 7 أشهر
- استخدام أسماء الأشهر باللغة العربية

**TopProducts** (`components/dashboard/top-products.tsx`)
- عرض المنتجات الأكثر مشاهدة بناءً على `view_count`
- عرض الحالة المميزة
- روابط سريعة لصفحات التعديل

**RecentOrders** → **RecentActivity** (`components/dashboard/recent-activity.tsx`)
- عرض سجل النشاطات الأخير
- عرض نوع العمل (إنشاء/تحديث/حذف) بألوان واضحة
- عرض من قام العمل المنفذ (منتج/مقال/مستخدم/مجموعة)
- روابط للوصول للعناصر

#### المكونات الجديدة:

**QuickActions** (`components/dashboard/quick-actions.tsx`)
- 5 أزرار إجراءات سريعة:
  - إضافة منتج جديد
  - إنشاء مجموعة
  - كتابة مقال
  - إضافة مستخدم
  - إنشاء لافتة
- أزرار ملونة بأيقونات

**ActivitySummary** (`components/dashboard/activity-summary.tsx`)
- إحصائيات النشاط: اليوم، هذا الأسبوع، هذا الشهر
- تفاصيل أنواع العمليات (إنشاء/تحديث/حذف)
- قائمة أكثر 3 مستخدمين نشاطاً

**PendingTasks** (`components/dashboard/pending-tasks.tsx`)
- عرض المهام المعلقة:
  - مقالات غير منشورة
  - منتجات غير منشورة
  - لافتات غير فعالة
- عداد إجمالي مع حالة "مكتملة" أو "مهام معلقة"

**SystemHealth** (`components/dashboard/system-health.tsx`)
- عرض حالة النظام:
  - حالة قاعدة البيانات (متصل/غير متصل)
  - حالة نظام التخزين (نشط/غير نشط)
  - حالة الخادم
- مؤشرات مرئية باللون الأخضر/الأحمر

**QuickSearch** (`components/dashboard/quick-search.tsx`)
- بحث سريع موحد عبر:
  - المنتجات
  - المقالات
  - المستخدمين
  - المجموعات
- عرض النتائج مع أيقونات النوع
- روابط مباشرة للصفحات

**ExportOptions** (`components/dashboard/export-options.tsx`)
- خيارات التصدير:
  - تصدير المنتجات إلى CSV
  - تصدير الإحصائيات إلى CSV
- تنزيل ملفات CSV تلقائياً

**UserActivity** (`components/dashboard/user-activity.tsx`)
- رسم بياني دائري (Pie Chart) لنشاط المستخدمين حسب الدور
- عرض نسب مدير/محرر

**TimeRangeFilter** (`components/dashboard/time-range-filter.tsx`)
- فلتر نطاق زمني:
  - اليوم، هذا الأسبوع، هذا الشهر، آخر 3 أشهر، العام الحالي، كل الوقت
- أيقونة تقويم

### 5. واجهات برمجة التطبيقات (API Routes)

**ملف جديد:** `app/api/search/route.ts`
- بحث موحد يبحث في المنتجات والمقالات والمستخدمين والمجموعات
- يرجع النتائج 5 لكل نوع

**ملف جديد:** `app/api/export/[type]/route.ts`
- تصدير المنتجات أو الإحصائيات إلى CSV

**ملف جديد:** `app/api/cron/monthly-stats/route.ts`
- نقطة نهاية cron job لتسجيل الإحصائيات الشهرية
- محمية بمفتاح CRON_SECRET

### 6. تتبع المشاهدات (View Tracking)

**ملف جديد:** `hooks/use-product-view.ts`
- هوك React لتتبع المشاهدات
- منع تكرار التتبع لنفس المنتج في 24 ساعة
- استخدام `trackProductView` action

**ملف جديد:** `app/(public)/products/[id]/view-tracker.tsx`
- مكون غير مرئي يستخدم `useProductView`
- يحدد عند تحميل صفحة المنتج

### 7. سكريبتات إضافية (Additional Scripts)

**ملف جديد:** `scripts/backfill-monthly-stats.ts`
- سكريبت لملء الإحصائيات الشهرية بالبيانات التاريخية
- يحسب الإحصائيات من بداية المشروع

## هيكل لوحة التحكم الجديد (New Dashboard Layout)

```
┌─────────────────────────────────────────────────────────────────────┐
│  لوحة التحكم                                         │
│  نظرة عامة على أداء المتجر                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  إجراءات سريعة                                      │
│  [إضافة منتج] [إنشاء مجموعة] [كتابة مقال]         │
│  [إضافة مستخدم] [إنشاء لافتة]                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  الإحصائيات (5 بطاقات)                               │
│  [المنتجات] [المجموعات] [المقالات] [المستخدمين]      │
│  [المشاهدات]                                          │
│  (تغييرات مقارنة بالشهر السابق)                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  فلتر زمني                                              │
│                                                      │
│  [اليوم ▾]                                          │
└─────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│  الرسوم البيانية (النشاط والمشاهدات)                     │
│                                                           │
└───────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  المنتجات الأكثر مشاهدة          │  ملخص النشاط           │
│                                   │                          │
│                                   │                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  آخر الأنشاط                  │  حالة النظام            │
│                                   │                          │
│                                   │                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  المهام المعلقة                  │  خيارات التصدير          │
│                                   │                          │
│                                   │                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  بحث سريع                                                │
│  البحث في: منتجات، مقالات، مستخدمين، مجموعات          │
└─────────────────────────────────────────────────────────────┘
```

## التقنيات المستخدمة (Technologies)

- **React Server Components**: Next.js 16 (App Router)
- **React Client Components**: React Hooks (useState, useEffect)
- **Database**: PostgreSQL مع Drizzle ORM
- **UI Components**: Radix UI (shadcn/ui)
- **Charts**: Recharts للرسوم البيانية
- **اللغة**: واجهة عربية بالكامل (RTL)

## الإحصائيات المعروضة (Metrics Display)

### البيانات الحقيقية:
- عدد المنتجات الإجمالي
- عدد المجموعات
- عدد مقالات المدونة
- عدد المستخدمين
- إجمالي المشاهدات لجميع المنتجات
- التغيير الشهري (مقارنة بالشهر السابق)

### البيانات التاريخية:
- المشاهدات شهرياً لآخر 7 أشهر
- عدد المنتجات شهرياً
- عدد مقالات المدونة شهرياً

### بيانات النشاط:
- نشاط اليوم
- نشاط هذا الأسبوع
- نشاط هذا الشهر
- توزيع العمليات (إنشاء/تحديث/حذف)
- أكثر المستخدمين نشاطاً

## ميزات الإدارة الجديدة (New Admin Features)

1. **إجراءات سريعة**: 5 أزرار للعمليات الشائعة
2. **المهام المعلقة**: عرض العناصر التي تحتاج انتباه
3. **ملخص النشاط**: نظرة شاملة على نشاط النظام
4. **حالة النظام**: مؤشرات حالة النظام في الوقت الفعلي
5. **البحث السريع**: بحث موحد عبر جميع الكيانات
6. **خيارات التصدير**: تصدير المنتجات والإحصائيات إلى CSV
7. **نشاط المستخدمين**: رسم بياني لتوزيع النشاط حسب الدور
8. **فلتر زمني**: تصفية البيانات حسب النطاق الزمني

## ملاحظات التنفيذ (Implementation Notes)

### قاعدة البيانات:
- تمت ترحيل `0001_add_analytics.sql` بنجاح باستخدام `drizzle-kit push`
- تمت عملية backfill الأولية

### تتبع المشاهدات:
- المشاهدات يتم تخزين في `products.view_count`
- يتم تسجيل كل مشاهدة في `product_view_history`
- يتم منع التكرار لنفس المنتج في نفس الجلسة (24 ساعة)
- يتم استخدام ملف تعريف الجلسة للتعرف على المستخدمين المسجلين

### Cron Job:
- نقطة النهاية: `/api/cron/monthly-stats`
- يجب تعيين `CRON_SECRET` في ملف `.env`
- يمكن استدعاؤها يدوياً أو إعدادها كـ scheduled task في Vercel

### الأداء:
- استخدام `React.cache()` للاستعلامات المتكررة (إذا لزم)
- الفلاتر المستخدمة بكفاءة (حيث أمكن)
- الجداول المستخدمة لجلب البيانات بمع `with` للعلاقات

### التعامل مع الأخطاء:
- جميع الاستعلامات في مكونات لوحة التحكم server-side
- أخطاء الأنواع محمية بكتل `try/catch`
- رسائل خطأ واضحة بالعربية

## الخطوات التالية (Next Steps)

### اختياري:

1. **إعداد Cron Job:**
   ```bash
   # إضافة إلى vercel.json أو استخدام Vercel Cron Jobs
   # URL: /api/cron/monthly-stats
   # تعيين CRON_SECRET في .env
   ```

2. **إضافة البحث إلى الشريط الجانبي:**
   - إضافة `QuickSearch` إلى `app/(dashboard)/layout.tsx`

3. **تحسين الأداء:**
   - إضافة فهرسة للجداول المستخدمة بشكل متكرر (index on view_count, last_viewed_at, created_at)
   - استخدام React.cache() لوظائف الاستعلام

4. **إشعارات في الوقت الفعلي:**
   - إضافة WebSocket أو polling لتحديث الإحصائيات مباشرة
   - إشعار للمهام المعلقة الجديدة

5. **تقارير متقدمة:**
   - تصدير PDF علاوة على CSV
   - رسوم بيانية إضافية (bar charts, stacked areas)
   - تصدير مخصصة

## الملفات المعدلة/الجديدة (Files Modified/Created)

### قاعدة البيانات:
- `lib/db/schema.ts` - إضافة الجداول والعلاقات الجديدة
- `drizzle/0001_add_analytics.sql` - ترحيل قاعدة البيانات

### وظائف الاستعلام:
- `lib/dashboard-queries.ts` - جديد (جميع وظائف الاستعلام للوحة التحكم)

### الإجراءات:
- `app/actions/analytics.ts` - جديد (تتبع المشاهدات وتسجيل الإحصائيات)

### المكونات:
- `components/dashboard/stats-cards.tsx` - محدث
- `components/dashboard/sales-chart.tsx` - محدث
- `components/dashboard/top-products.tsx` - محدث
- `components/dashboard/recent-activity.tsx` - جديد
- `components/dashboard/quick-actions.tsx` - جديد
- `components/dashboard/activity-summary.tsx` - جديد
- `components/dashboard/pending-tasks.tsx` - جديد
- `components/dashboard/system-health.tsx` - جديد
- `components/dashboard/quick-search.tsx` - جديد
- `components/dashboard/export-options.tsx` - جديد
- `components/dashboard/time-range-filter.tsx` - جديد
- `components/dashboard/user-activity.tsx` - جديد

### صفحات التطبيق:
- `app/(dashboard)/dashboard/page.tsx` - محدث بالكامل
- `app/api/search/route.ts` - جديد
- `app/api/export/[type]/route.ts` - جديد
- `app/api/cron/monthly-stats/route.ts` - جديد

### Hooks:
- `hooks/use-product-view.ts` - جديد

### السكريبتات:
- `scripts/backfill-monthly-stats.ts` - جديد

## الاستخدام (Usage)

### للمستخدمين:
1. **عرض الإحصائيات الحقيقية**:
   - جميع الأرقام مستخرجة من قاعدة البيانات
   - التغييرات الشهرية مقارنة بالشهر السابق

2. **التحليل البياني**:
   - رؤية الاتجاهات على مدار 7 أشهر
   - فهم توزيع نشاط المستخدمين حسب الدور

3. **إجراءات سريعة**:
   - إنشاء عناصر جديدة بضغطة واحدة
   - توفير الوقت وتقليل الخطوات

4. **تتبع المشاهدات**:
   - معرفة المنتجات الأكثر شعبية
   - تحليل الأداء

5. **البحث الموحد**:
   - البحث في كل شيء من مكان واحد
   - نتائج سريعة مع روابط مباشرة

### للمطورين:
- **قاعدة البيانات**: استخدام Drizzle ORM مع PostgreSQL
- **API**: Next.js App Router
- **مكونات**: شادcn/ui + React
- **الرسوم البيانية**: Recharts
- **اللغة**: RTL بالعربية
- **الأنواع**: TypeScript بـ Zod للتحقق

## مشاكل معروفة وحلولها (Known Issues & Solutions)

### مشكلة: عرض فارغ للبيانات
- **الحل**: جميع المكونات تعالج الحالة الفارغة برسائل واضحة بالعربية

### مشكلة: Cron Job
- **الحل**: إنشاء ملف `.env` وتعيين `CRON_SECRET`
- **خيار**: تشغيل يدوياً عند الحاجة بدلاً من Cron

### مشكلة: الترحيب في المشاهدات
- **الحل**: منع التكرار لمدة 24 ساعة فقط

## التعليمات (Instructions)

### تشغيل التطبيق:
```bash
npm run dev
```

### تشغيل السكريبتات:
```bash
# تشغيل السكريبت الـ backfill
npx tsx ./scripts/backfill-monthly-stats.ts

# تشغيل الترحيل (تم بالفعل)
npx drizzle-kit push
```

### إعداد Cron Job:
```bash
# 1. إنشاء مفتاح سري عشوائي
openssl rand -hex 32

# 2. إضافته إلى .env
CRON_SECRET=your-secret-key-here

# 3. إضافة نقطة نهاية إلى vercel.json:
{
  "crons": [
    {
      "path": "/api/cron/monthly-stats",
      "schedule": "0 0 1 * *"
    }
  ]
}

# 4. نشر التطبيق
vercel --prod
```

### تشغيل Cron Job يدوياً:
```bash
curl -X GET \
  -H "Authorization: Bearer your-secret-key-here" \
  https://your-app.vercel.app/api/cron/monthly-stats
```

## الصيانة والتحديثات (Maintenance)

### إحصائيات شهري:
- يتم تسجيل الإحصائيات تلقائياً في أول كل شهر عبر Cron Job
- يمكن إعادة التشغيل يدوياً عند الحاجة

### قاعدة البيانات:
- النظر في إنشاء فهارس على الجداول المطلوبة بشكل متكرر
- مراقبة حجم `product_view_history` وحذف البيانات القديمة إذا لزم

### الأداء:
- مراقبة زمن الاستجابة للصفحات
- استخدام React Cache أو استراتيجيات caching أخرى
- فحص استعلامات البحث وتحسينها

## التوسعات المستقبلية (Future Enhancements)

### ممكن تحقيقه الآن:
1. إشارات في الوقت الفعلي لتحديثات فورية
2. تصدير PDF و Excel
3. رسوم بيانية أكثر تفصيلاً (بشكل متراكب، خطوط منطقة)
4. تصفير متقدم للبيانات (متعدد الفلاتر)
5. سجل مراجعة للنشاط (سجل التدقيق)
6. لوحة تحكم للجوال
7. تعليقات على النشاط للتعاون بين المديرين

### تتطلب تخطيط أطول:
1. نظام إشعارات متكامل
2. أتمتة بيانات (Advanced Analytics) - تجارة eCommerce، توقعات العملاء، معدلات التحويل
3. إدارة المهام (Task Management) - تعيين المهام، تتبع التقدم، تواريخ الاستحقاق
4. إدارة المستخدمين المتقدمة - أدوار مخصصة، أذونات مفصلة، تقييمات أداء

## الدعم (Support)

للمشاكل أو استفسارات:
- مراجعة هذا الملف للتوثيق الكامل
- التحقق من `lib/dashboard-queries.ts` لوظائف الاستعلام
- التحقق من `lib/db/schema.ts` لتعريف الجداول
- مراجعة `components/dashboard/` للمكونات

---

**تطوير بواسطة:** AI Assistant
**الإصدار:** 1.0.0
**التاريخ:** يناير 2025
